{% extends 'base.html' %}
{% load static %}
{% block style %}
  <style>
    .profile-title {
      display: flex;
      flex-flow: row;
    }

    .info {
      padding-bottom: 10px;
    }

    .post-block {
      display: flex;
      height: 10vh;
      width: 100%;
      justify-content: center;
    }

    .bg-img {
      position: absolute;
      background-size: cover;
      opacity: 0.33;
      /*width: 200%;*/
      height: 100%;
      z-index: -3;
    }

    .profile-img {
      border: 0.5rem red;
      width: 25%;
      margin-right: 3rem;
    }
  </style>
{% endblock style%}
{% block title %}
  mypage
{% endblock title %}
{% block content %}
  <div class="bg-img">
    <img src="{% static '/img/profile_bg.jpg' %}" alt="profil_background_image">
  </div>
  <div class="container">
    <!-- ì‚¬ìš©ì í”„ë¡œí•„ ì •ë³´ -->
    <div class="row align-items-start profile-title">
      <!-- í”„ë¡œí•„ ì´ë¯¸ì§€ -->

      {% if person.profile_image %}
        <img src="{{ person.profile_image.url }}" alt="post_image" class="col-4 rounded-circle profile-img">
      {% else %}
        <img src="https://i.pinimg.com/564x/d2/98/4e/d2984ec4b65a8568eab3dc2b640fc58e.jpg" alt="no_image" class="col-4 rounded-circle profile-img">
      {% endif %}

      <div class="col-8">

        <div class="row justify-content-start align-items-center my-1">
          <!-- ì‚¬ìš©ì ì´ë¦„ -->

          <h1 class="col-4">{{ person.username }}</h1>

          <!-- íŒ”ë¡œìš° ë²„íŠ¼ / íšŒì›ì •ë³´ ìˆ˜ì • ë²„íŠ¼ -->
          <div class="col-8">
            {% if request.user.is_authenticated %}
              {% if user.username != person.username %}
                {% if request.user in person.followers.all %}
                  <input type="submit" value="ì–¸íŒ”ë¡œìš°" class="btn btn-success">
                {% else %}
                  <input type="submit" value="íŒ”ë¡œìš°" class="btn btn-success">
                {% endif %}
              {% else %}
                <form id="follow-form" data-user-id="{{ person.pk }}">
                  {% csrf_token %}
                  <a href="{% url 'accounts:update' %}" class="button btn btn-success">íšŒì›ì •ë³´ ìˆ˜ì •</a>
                </form>
              {% endif %}
            {% else %}
              <input type="submit" value="íŒ”ë¡œìš°" class="btn btn-secondary disabled">
            {% endif %}
          </div>
        </div>

        <!-- íŒ”ë¡œì‰ / íŒ”ë¡œì›Œ / ë§íŒ” ëª©ë¡ -->
        <div class="row row-cols-auto align-items-center my-1 p-1">
          <div class="col-4">
            <div></div>
          </div>

          <div class="col ms-2">
            <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#exampleModal1">
              íŒ”ë¡œì‰
              {{ person.followings.all|length }}
              ëª…
            </button>
          </div>
          <div class="col">
            <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#exampleModal2">
              íŒ”ë¡œì›Œ
              <span id="followers-count">{{ person.followers.all|length }}</span>
              ëª…
            </button>
          </div>
          <div class="col">
            <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#exampleModal3">
              ë§íŒ” ëª©ë¡
            </button>
          </div>
        </div>

        <!-- ì‚¬ìš©ì ì •ë³´ -->
        <div class="mt-3">
          <div class="col info">
            <h3>
              {{ person.nickname }}
            </h3>
          </div>
          <div class="col info">
            <h4>
              {{ person.email }}
            </h4>
          </div>
          <div class="col info">
            <h5>
              {% if person.status_message %}
                {{ person.status_message }}
              {% else %}
                <a href="{% url 'accounts:update' %}" style="text-decoration: none;
        color: inherit;">
                  <p>ìƒíƒœë©”ì„¸ì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš” :)</p>
                </a>
              {% endif %}
            </h5>
          </div>
        </div>
      </div>
    </div>

    <hr>

    <div class="m-1 col">
      <!-- ì‚¬ìš©ìê°€ ì‘ì„±í•œ ê²Œì‹œê¸€ -->
      <div class="col">
        <h1 class="mt-3 px-5 py-3">ê²Œì‹œê¸€</h1>
        {% for post in person.post_set.all %}
          <div class="card m-4" style="max-width: 90%;">
            <div class="row g-0">
              <div class="col-2">
                {% if post.post_image %}
                  <img src="{{ post.post_image.url }}" alt="post_image" class="card-img rounded-start">
                {% else %}
                  <img src="{% static 'no_image.jpg' %}" alt="no_image" class="card-img rounded-start">
                {% endif %}
              </div>
              <div class="col-10">
                <div class="card-body p-3">
                  <h2 class="card-title">
                    <a href="{% url 'posts:detail' post.pk %}" style="text-decoration: none;">
                      {{ post.name }}
                    </a>
                  </h2>
                  <p class="card-text">{{ post.address }}</p>
                  <p class="card-text">{{ post.description | truncatewords:40 }}</p>
                  <div class="align-self-start">
                    ğŸ’š
                    {{ post.like_users.count }}
                  </div>
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
    <hr>

    <div class="m-1 col">
      <!-- ì‚¬ìš©ìê°€ ì¢‹ì•„ìš” í•œ ì‹œì„¤ -->
      <div class="col">
        <h1 class="mt-3 px-5 py-3">ì¢‹ì•„ìš”</h1>
        {% for post in person.like_posts.all %}
          <a href="{% url 'posts:detail' post.pk %}" style="text-decoration: none;">
            <div class="card m-4" style="max-width: 90%;">
              <div class="row g-0">
                <div class="col-2">
                  {% if post.post_image %}
                    <img src="{{ post.post_image.url }}" alt="post_image" class="card-img rounded-start">
                  {% else %}
                    <img src="{% static 'no_image.jpg' %}" alt="no_image" class="card-img rounded-start">
                  {% endif %}
                </div>
                <div class="col-10">
                  <div class="card-body p-3">
                    <h2 class="card-title">
                      {{ post.name }}
                    </h2>
                    <p class="card-text">{{ post.address }}</p>
                    <p class="card-text">{{ post.description | truncatewords:40 }}</p>
                    <div class="align-self-start">
                      ğŸ’š
                      {{ post.like_users.count }}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </a>
        {% endfor %}
      </div>
    </div>
    <hr>

    <div class="m-1 col">
      <!-- ì‚¬ìš©ìê°€ ì‘ì„±í•œ ë¦¬ë·° -->
      <div class="col">
        <h1 class="mt-3 px-5 py-3">ë¦¬ë·°</h1>
        {% for revieww in reviews_set.all %}
          <div class="card m-4" style="max-width: 90%;">
            <div class="row g-0">
              <div class="col-2">
                {% if revieww.post_image %}
                  <img src="{{ post.post_image.url }}" alt="post_image" class="card-img rounded-start">
                {% else %}
                  <img src="{% static 'no_image.jpg' %}" alt="no_image" class="card-img rounded-start">
                {% endif %}
              </div>
              <div class="col-10">
                <div class="card-body p-3">
                  <h2 class="card-title">
                    <a href="{% url 'posts:detail' review.post.pk %}" style="text-decoration: none;">
                      {{ revieww.review }}
                    </a>
                  </h2>
                  <p class="card-text">{{ post.address }}</p>
                  <p class="card-text">{{ post.description | truncatewords:40 }}</p>
                  <div class="align-self-start">
                    ğŸ’š
                    {{ post.like_users.count }}
                  </div>
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

    <!-- ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ -->
    <div class="col-2 py-2">
      <a class="change-passwosrd btn btn-success" style="width:100%; padding:10px; font-size: 22px;" on-click='func()' href="{% url 'accounts:change_password' %}">
        ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
      </a>
    </div>

    <!-- íšŒì› íƒˆí‡´-->
    <div class="col-2">
      <a class="change-passwosrd btn btn-secondary" style="width:100%; padding:10px; font-size: 22px;" on-click='func()' href="{% url 'accounts:delete' %}">
        íšŒì› íƒˆí‡´
      </a>
    </div>
  </div>

  <div class="modal fade" id="exampleModal1" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="exampleModalLabel">{{ person.username }}
            ë‹˜ì˜ íŒ”ë¡œì‰ ëª©ë¡</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          {% for following in person.followings.all %}
            <p>
              <a href="{% url 'accounts:profile' following.username %}" style="text-decoration: none;">{{ following.username }}</a>
            </p>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="exampleModal2" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="exampleModalLabel">{{ person.username }}
            ë‹˜ì˜ íŒ”ë¡œì›Œ ëª©ë¡</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          {% for follower in person.followers.all %}
            <p>
              <a href="{% url 'accounts:profile' follower.username %}" style="text-decoration: none;">{{ follower.username }}</a>
            </p>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="exampleModal3" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="exampleModalLabel">{{ person.username }}
            ë‹˜ì˜ ë§íŒ”ë¡œì›Œ ëª©ë¡</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          {% for follower in person.followers.all %}
            {% if person in follower.followers.all %}
              <p>
                <a href="{% url 'accounts:profile' follower.username %}" style="text-decoration: none;">{{ follower.username }}</a>
              </p>
            {% endif %}
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>
</div>

{% endblock content %}

{% block script %}
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
const form = document.querySelector('#follow-form')
const csrftoken = document
  .querySelector('[name=csrfmiddlewaretoken]')
  .value

  form
  .addEventListener('submit', function (event) {
    event.preventDefault()

    const userId = event
      .target
      .dataset
      .userId

      axios({
        method: 'post',
        url: `/accounts/${userId}/follow/`,
        headers: {
          'X-CSRFToken': csrftoken
        }
      })
      .then((response) => {
        // console.log(response.data)
        const isFollowed = response.data.is_followed
        const followBtn = document.querySelector('#follow-form > input[type=submit]')
        if (isFollowed === true) {
          followBtn.value = 'ì–¸íŒ”ë¡œìš°'
        } else {
          followBtn.value = 'íŒ”ë¡œìš°'
        }

        const followingCountTag = document.querySelector('#followings-count')
        const followerCountTag = document.querySelector('#followers-count')

        const followingsCountData = response.data.followings_count
        const followersCountData = response.data.followers_count

        followingCountTag.textContent = followingsCountData
        followerCountTag.textContent = followersCountData
      })
  })
</script>
{% endblock script %}
